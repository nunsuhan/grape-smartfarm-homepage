# FarmSense 기술 레퍼런스 문서
## 안티그래비티 [Reference & Science] 섹션용

---

# 1. 알고리즘 수식/로직

---

## 1.1 PMI (Powdery Mildew Index) - 흰가루병 위험 지수

### 수식
```
PMI = Σ(hourly_risk) / 24

where hourly_risk =
  | 1.0  if 21°C ≤ T ≤ 30°C AND 40% ≤ RH ≤ 70%  (최적 조건)
  | 0.7  if 18°C ≤ T ≤ 33°C AND 35% ≤ RH ≤ 80%  (위험 조건)
  | 0.3  if 15°C ≤ T ≤ 35°C AND 30% ≤ RH ≤ 85%  (주의 조건)
  | 0.0  otherwise
```

### 의사결정 로직
```
PMI ≥ 0.7  →  🔴 긴급 (24시간 내 방제 권장)
PMI ≥ 0.5  →  🟠 경고 (48시간 내 예방 살포)
PMI ≥ 0.3  →  🟡 주의 (모니터링 강화)
PMI < 0.3  →  🟢 안전
```

### 시각화 예시
```
[온도-습도 위험 매트릭스]

습도(%)
  90 ┃░░░░░░░░░░░░░░░░░░░░
  80 ┃░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░
  70 ┃░░░░▒▒▓▓▓▓▓▓▒▒░░░░░░  ▓ 최적(위험)
  60 ┃░░░░▒▒▓▓██▓▓▒▒░░░░░░  █ 고위험
  50 ┃░░░░▒▒▓▓▓▓▓▓▒▒░░░░░░  ▒ 주의
  40 ┃░░░░▒▒▒▒▒▒▒▒▒▒░░░░░░  ░ 안전
  30 ┃░░░░░░░░░░░░░░░░░░░░
     ┗━━━━━━━━━━━━━━━━━━━━━
       10  15  20  25  30  35  온도(°C)
```

---

## 1.2 노균병 (Downy Mildew) 감염 모델

### Mills Chart 기반 수식
```
Infection_Hours = f(Temperature, Leaf_Wetness_Duration)

최소 감염 조건:
  - T = 10°C → 습윤 지속 24시간 이상
  - T = 15°C → 습윤 지속 12시간 이상
  - T = 20°C → 습윤 지속 6시간 이상
  - T = 25°C → 습윤 지속 4시간 이상

감염 확률:
P(infection) = min(1.0, wetness_hours / required_hours)
```

### 의사결정 트리
```
                    [현재 습도 체크]
                          │
              ┌───────────┴───────────┐
           RH ≥ 85%               RH < 85%
              │                       │
    [엽면 습윤 시간 체크]          [안전]
              │
    ┌─────────┼─────────┐
  ≥12h      6-12h      <6h
    │         │         │
[🔴 긴급]  [🟠 경고]  [🟡 주의]
    │         │
    ▼         ▼
"24시간 내   "48시간 내
 방제 필수"   예방 권장"
```

---

## 1.3 GDD (Growing Degree Days) - 생육 적산 온도

### 수식
```
GDD_daily = max(0, (T_max + T_min) / 2 - T_base)

GDD_cumulative = Σ(GDD_daily) from budbreak

where:
  T_base = 10°C (포도 기준)
  T_max = min(실제최고기온, 30°C)  // 상한 보정
  T_min = max(실제최저기온, 10°C)  // 하한 보정
```

### 생육 단계 판정
```
GDD 누적    생육 단계           주요 작업
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0-100      발아기(Bud Break)    -
100-300    전엽기(Leaf Out)     적심 준비
300-500    개화기(Flowering)    GA 1차 처리
500-800    착과기(Fruit Set)    GA 2차, 적방
800-1200   비대기(Berry Dev)    봉지씌우기
1200-1600  착색기(Veraison)     적엽
1600-2000  성숙기(Ripening)     당도 체크
2000+      수확기(Harvest)      수확
```

---

## 1.4 DOSAVIÑA - 살포량 계산 알고리즘

### TRV (Tree Row Volume) 수식
```
TRV = (H × W × 10,000) / R

where:
  H = 수관 높이 (m)
  W = 수관 폭 (m)
  R = 열간 거리 (m)
  
단위: m³/ha
```

### 살포량 계산
```
Spray_Volume = TRV × LWA × Recovery_Factor

where:
  LWA (Leaf Wall Area) = 수관 밀도 계수
    - 휴면기: 0.2
    - 초기: 0.5
    - 중기: 0.8
    - 만기: 1.0
    
  Recovery_Factor = 살포기 효율
    - SS기: 0.6-0.8
    - 동력분무기: 0.3-0.5
```

### 계산 예시
```
[샤인머스캣 비가림하우스]
━━━━━━━━━━━━━━━━━━━━━━━━━
입력:
  - 수관 높이: 2.0m
  - 수관 폭: 1.2m
  - 열간 거리: 3.0m
  - 면적: 1,000평 (3,300m²)
  - 생육단계: 비대기 (LWA=0.8)

계산:
  TRV = (2.0 × 1.2 × 10,000) / 3.0 = 8,000 m³/ha
  
  기준 살포량 = 8,000 × 0.8 × 0.1 = 640 L/ha
  
  내 농장 살포량 = 640 × 0.33ha = 211 L

결과:
  💧 권장 살포량: 약 210L
  🧪 희석배수 1,000배 시 → 약제 210ml
```

---

## 1.5 수확량 예측 모델 (LAI 기반)

### LAI → 수확량 변환 수식
```
Yield = Base_Yield × LAI_Factor × Area_Factor × Variety_Factor

where:
  Base_Yield (kg/ha):
    - 샤인머스캣: 25,000
    - 캠벨얼리: 30,000
    - 거봉: 28,000
    - MBA: 32,000

  LAI_Factor = 1 - |LAI - 4.0| × 0.1
    (LAI 4.0이 최적, 벗어날수록 감소)
    
  Canopy_Cover = 1 - e^(-k × LAI)
    where k = 0.5 (광소멸계수)
```

### LAI-수확량 상관관계
```
LAI     피복률    예상수율(상대값)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.0     39%       60%
2.0     63%       80%
3.0     78%       95%
3.5     83%       100% (최적)
4.0     86%       100% (최적)
4.5     89%       95%
5.0     92%       85% (과밀)
```

---

# 2. 핵심 논문 레퍼런스

---

## 2.1 병해 예측 모델

| # | 논문 제목 | 저자 | 연도 | 핵심 내용 |
|---|----------|------|------|----------|
| 1 | **Prediction models for downy mildew of grape based on weather conditions** | Caffi et al. | 2011 | 노균병 감염 모델, Mills Chart 개선 |
| 2 | **Development and validation of a model for powdery mildew on grapevine** | Carisse et al. | 2009 | 흰가루병 PMI 지수 개발 |
| 3 | **포도 노균병 발생예측을 위한 기상요인 분석** | 농촌진흥청 | 2018 | 국내 포도 환경 적용 |

## 2.2 살포량 최적화

| # | 논문 제목 | 저자 | 연도 | 핵심 내용 |
|---|----------|------|------|----------|
| 4 | **DOSAVIÑA: Dosage calculation tool for vineyard spray applications** | Gil et al. | 2007 | TRV 기반 살포량 계산 |
| 5 | **Spray Volume Optimization in Vineyards** | Pergher & Petris | 2008 | 수관 밀도별 최적 살포량 |

## 2.3 수확량 예측

| # | 논문 제목 | 저자 | 연도 | 핵심 내용 |
|---|----------|------|------|----------|
| 6 | **VitiCanopy: A free computer app to estimate canopy vigor and porosity** | De Bei et al. | 2016 | LAI 측정 알고리즘 |
| 7 | **Predicting grape yield based on vegetation indices** | Hall et al. | 2011 | NDVI-수확량 상관관계 |
| 8 | **포도 착색기 엽면적지수와 수량 및 품질과의 관계** | 농촌진흥청 | 2015 | 국내 품종 LAI 연구 |

## 2.4 AI/딥러닝 진단

| # | 논문 제목 | 저자 | 연도 | 핵심 내용 |
|---|----------|------|------|----------|
| 9 | **Deep learning for plant disease detection** | Mohanty et al. | 2016 | CNN 기반 병해 분류 |
| 10 | **EfficientNet: Rethinking Model Scaling** | Tan & Le | 2019 | EfficientNet 아키텍처 |

---

# 3. 의사결정 트리 시나리오

---

## 3.1 노균병 조기 경보 시나리오
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
시간   조건                    시스템 판단          사용자 알림
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

T+0h   습도 85% 돌파           ⚠️ 감시 시작        -
       온도 22°C
       
T+4h   습도 90% 유지           📊 누적 시작        "습도 주의"
       엽면습윤 감지            wetness_hours=4     
       
T+8h   습도 92%                📊 위험도 상승      "노균병 주의보"
       엽면습윤 8시간 지속      P(infection)=0.67   모니터링 권장
       
T+12h  습도 90%                🔴 감염 임계 도달   "🚨 노균병 경보"
       엽면습윤 12시간          P(infection)=1.0    24시간 내 방제
       
T+24h  (방제 미실시 시)         ⚫ 포자 형성 예상   "긴급 방제 필요"
       잠복기 진입                                  피해 확산 경고
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 3.2 통합 의사결정 플로우
```
┌─────────────────────────────────────────────────────────────┐
│                    📷 사진 업로드                           │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              [Stage 1] 4-Class 필터                         │
│                                                             │
│   정상(70%)  │  병해(20%)  │  해충(5%)  │  기타(5%)        │
└──────┬──────────────┬───────────────────────────────────────┘
       │              │
       ▼              ▼
    [종료]    ┌───────────────────────────────────────────────┐
              │         [Stage 2] 10-Class 정밀 진단          │
              │                                               │
              │  탄저병   노균병   갈색무늬   새눈무늬   ...  │
              │   15%      65%      10%        5%            │
              └───────────────────┬───────────────────────────┘
                                  │
                                  ▼
              ┌───────────────────────────────────────────────┐
              │           [환경 데이터 융합]                  │
              │                                               │
              │  현재 습도: 92% (노균병 최적)                 │
              │  최근 강우: 2일 전                            │
              │  PMI 지수: 0.3 (낮음)                         │
              │                                               │
              │  → 노균병 가중치 +15%                        │
              │  → 최종: 노균병 80%                          │
              └───────────────────┬───────────────────────────┘
                                  │
                                  ▼
              ┌───────────────────────────────────────────────┐
              │            [RAG 처방 생성]                    │
              │                                               │
              │  🔍 검색: "노균병 초기 방제"                  │
              │                                               │
              │  📋 처방전:                                   │
              │  • 1차 약제: 포리옥신 (수확 7일전)           │
              │  • 2차 약제: 안트라콜 (수확 14일전)          │
              │  • 살포량: 210L (DOSAVIÑA 계산)              │
              │  • 살포 시기: 24시간 내 권장                 │
              └───────────────────────────────────────────────┘
```

## 3.3 캐노피 분석 → 수확량 예측 플로우
```
┌─────────────────────────────────────────────────────────────┐
│                   📷 수관 사진 촬영                         │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│               [이미지 분석 - VitiCanopy]                    │
│                                                             │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│   │ 원본    │ →   │ 이진화  │ →   │ 피복률  │             │
│   │ 이미지  │     │ 처리    │     │ 계산    │             │
│   └─────────┘     └─────────┘     └─────────┘             │
│                                                             │
│   피복률: 82.6%                                            │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    [LAI 역산]                               │
│                                                             │
│   Cover = 1 - e^(-k × LAI)                                 │
│   0.826 = 1 - e^(-0.5 × LAI)                               │
│   LAI = -ln(0.174) / 0.5 = 3.5                             │
│                                                             │
│   결과: LAI = 3.5 (최적 범위: 3.5~4.5)                     │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                 [수확량 예측]                               │
│                                                             │
│   품종: 샤인머스캣                                         │
│   면적: 3,000 m² (0.3 ha)                                  │
│   기준수량: 25,000 kg/ha                                   │
│                                                             │
│   LAI_Factor = 1 - |3.5 - 4.0| × 0.1 = 0.95               │
│                                                             │
│   예측수량 = 25,000 × 0.95 × 0.3 = 7,125 kg               │
│                                                             │
│   ✅ 예상 수확량: 약 7,500 kg                              │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   [권장사항]                                │
│                                                             │
│   LAI 3.5 → ✅ 적정 범위                                   │
│                                                             │
│   💡 권장: 현재 상태 유지                                  │
│   ⚠️ 주의: 과밀 시 통풍 불량 → 병해 위험                  │
└─────────────────────────────────────────────────────────────┘
```

---

# 4. 애니메이션/시각화 제안

---

## 4.1 실시간 데이터 흐름 시각화
```
[센서]          [서버]           [AI]            [앱]
  │               │               │               │
  │──온도 23.5°C─▶│               │               │
  │──습도 85%────▶│───집계────────▶│               │
  │──토양수분────▶│               │               │
  │               │               │──위험도 계산─▶│
  │               │               │               │
  │               │◀──PMI=0.72────│               │
  │               │               │               │
  │               │───────────────│───🔔 알림───▶│
  │               │               │               │
  
  [1초마다]      [5분 집계]     [실시간 분석]   [푸시 알림]
```

## 4.2 AI 파이프라인 애니메이션 시퀀스
```
Frame 1: 📷 사진 입력
         ↓
Frame 2: [████████░░] 4-Class 분류 중...
         ↓
Frame 3: 결과: 병해 의심 (85%)
         ↓
Frame 4: [████████░░] 10-Class 정밀 분석...
         ↓
Frame 5: 노균병 65% / 탄저병 20% / 기타 15%
         ↓
Frame 6: [████████░░] 환경 데이터 융합...
         ↓
Frame 7: 최종: 노균병 80% (환경 가중 적용)
         ↓
Frame 8: [████████░░] 처방전 생성...
         ↓
Frame 9: ✅ 완료! 처방전 표시
```

---

# 5. 기술 스택 요약
```
┌─────────────────────────────────────────────────────────────┐
│                      FarmSense Tech Stack                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [AI/ML Layer]                                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │Efficient│ │ YOLOv8  │ │ChromaDB │ │ Korean  │          │
│  │ Net-B0  │ │         │ │  (RAG)  │ │ SBERT   │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                             │
│  [Algorithm Layer]                                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │   PMI   │ │   GDD   │ │DOSAVIÑA │ │  Yield  │          │
│  │  Index  │ │ Calc    │ │  Spray  │ │Predictor│          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                             │
│  [Data Layer]                                               │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │Timescale│ │ 400M    │ │  78K    │ │  287K   │          │
│  │   DB    │ │ Sensors │ │ Images  │ │ Chunks  │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                             │
│  [API Layer]                                                │
│  ┌─────────────────────────────────────────────┐          │
│  │           Django REST Framework             │          │
│  │     + 기상청 + 농사로 + 스마트팜코리아      │          │
│  └─────────────────────────────────────────────┘          │
│                                                             │
│  [Client Layer]                                             │
│  ┌─────────────────────────────────────────────┐          │
│  │              React Native App               │          │
│  └─────────────────────────────────────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📎 첨부 자료

추가로 필요한 자료:
1. 실제 앱 스크린샷 - 요청 시 제공
2. API 응답 샘플 JSON - 요청 시 제공
3. 센서 데이터 샘플 CSV - 요청 시 제공

---

*작성: FarmSense Backend Team*
*문의: artmer3061@gmail.com*
